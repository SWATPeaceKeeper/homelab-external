#cloud-config
# ============================================================================
# Homelab External Server - Cloud-Init (Basis-Provisionierung)
# ============================================================================
# Statische Datei ohne Template-Variablen.
# Macht nur das Basis-Setup. Repo klonen, .env und Docker Compose
# werden von bootstrap.sh per SSH erledigt.
# ============================================================================

package_update: true
package_upgrade: true

# -----------------------------------------------------------------------------
# BASIS-PAKETE
# -----------------------------------------------------------------------------
packages:
  - ca-certificates
  - curl
  - git
  - htop
  - vim
  - jq
  - fail2ban
  - ufw
  - apache2-utils

# -----------------------------------------------------------------------------
# SETUP COMMANDS
# -----------------------------------------------------------------------------
runcmd:
  # =========================================================================
  # DOCKER INSTALLATION (Ubuntu 24.04)
  # =========================================================================
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc
  - |
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  - systemctl enable docker
  - systemctl start docker
  - ln -sf /usr/libexec/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose

  # =========================================================================
  # FIREWALL (UFW)
  # =========================================================================
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 3478/udp
  - ufw allow 3478/tcp
  - ufw --force enable

  # =========================================================================
  # FAIL2BAN
  # =========================================================================
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # =========================================================================
  # ORDNERSTRUKTUR
  # =========================================================================
  - mkdir -p /opt/homelab-repo
  - mkdir -p /opt/homelab-data/traefik/certs
  - mkdir -p /opt/homelab-data/headscale
  - mkdir -p /opt/homelab-data/headscale-postgres
  - mkdir -p /opt/homelab-data/headplane
  - mkdir -p /opt/homelab-data/secrets
  - mkdir -p /opt/homelab-data/uptime-kuma
  - mkdir -p /opt/homelab-data/ntfy/cache
  - mkdir -p /opt/homelab-data/ntfy/data
  - mkdir -p /opt/homelab-data/healthchecks
  - mkdir -p /opt/homelab-data/healthchecks-postgres
  - mkdir -p /opt/homelab-data/tailscale
  - mkdir -p /opt/homelab-data/dockge
  - mkdir -p /opt/stacks

  # acme.json für Let's Encrypt (MUSS 600 sein!)
  - touch /opt/homelab-data/traefik/certs/acme.json
  - chmod 600 /opt/homelab-data/traefik/certs/acme.json

  # Cookie Secret für Headplane (32 Zeichen hex)
  - openssl rand -hex 16 > /opt/homelab-data/secrets/cookie_secret
  - chmod 600 /opt/homelab-data/secrets/cookie_secret

  # =========================================================================
  # ABSCHLUSS
  # =========================================================================
  - echo "Cloud-Init abgeschlossen: $(date)" >> /var/log/cloud-init-complete.log

# -----------------------------------------------------------------------------
# SYSTEM-KONFIGURATION
# -----------------------------------------------------------------------------
timezone: Europe/Berlin
locale: de_DE.UTF-8

ssh_pwauth: false
disable_root: false

# -----------------------------------------------------------------------------
# SWAP (2GB für Server mit 4GB RAM)
# -----------------------------------------------------------------------------
swap:
  filename: /swapfile
  size: 2G
  maxsize: 2G
