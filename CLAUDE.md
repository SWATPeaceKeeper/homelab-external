# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Self-hosted homelab infrastructure on Hetzner Cloud (CX23, ~5 EUR/month). Provisioned via shell scripts (`bootstrap.sh` / `teardown.sh`) and Docker Compose. Documentation and comments are in German.

**Services:** Headscale (VPN), Headplane (VPN UI), Traefik (reverse proxy + SSL), Uptime Kuma (monitoring), ntfy (push notifications), Healthchecks (cron monitoring), Dockge (Docker Compose UI), Tailscale client, two PostgreSQL databases (17-alpine).

## Architecture

### Provisioning

- **`bootstrap.sh`** — Creates everything: Hetzner server + firewall + SSH key, Cloudflare DNS records, clones repo, generates `.env`, starts Docker Compose, bootstraps Headscale. Requires `HCLOUD_TOKEN`, `CLOUDFLARE_API_TOKEN`, `CLOUDFLARE_ZONE_ID`. Uses `remote()` helper for all SSH commands with explicit `-i "$SSH_KEY_FILE"`.
- **`teardown.sh`** — Destroys everything: server, firewall, SSH key, DNS records. Requires "yes" confirmation.
- **`cloud-init.yaml`** — Static (no template variables). Base setup only: packages, Docker, UFW, fail2ban, directory structure, acme.json, cookie_secret, swap. YAML gotcha: shell commands with colons must use list syntax `['bash', '-c', '...']` to avoid YAML parsing errors.
- No Terraform, no CI/CD, no GitHub Secrets. All provisioning runs locally.

### Runtime Configuration

- **`hetzner/`** — Deployed to `/opt/homelab-repo/hetzner/` on the server. Docker Compose orchestrates all services. Config changes deployed manually (git pull on server).

### Network Architecture

- **`proxy` network**: Services exposed via Traefik (headscale, headplane, uptime-kuma, ntfy, healthchecks, dockge)
- **`internal` network**: Database containers + services that need DB access (headscale-postgres, healthchecks-postgres, headscale, headplane, healthchecks)
- **host network**: Tailscale client (needs NET_ADMIN)
- Routing configured via Traefik Docker labels on each service

### Data Separation

- **Git repo configs** (read-only mounts): `./traefik/`, `./headscale/`, `./headplane/`
- **Persistent data** (on server, not in git): `/opt/homelab-data/<service>/`
- **Secrets**: `/opt/homelab-data/secrets/` (cookie_secret generated by Cloud-Init)

### Secrets Management

- Three env vars needed locally for provisioning: `HCLOUD_TOKEN`, `CLOUDFLARE_API_TOKEN`, `CLOUDFLARE_ZONE_ID`
- Runtime secrets in `hetzner/.env` (generated by `bootstrap.sh`, never committed)
- Headscale DB password: env var `HEADSCALE_DATABASE_POSTGRES_PASS` overrides config.yaml value
- Traefik dashboard: Basic Auth via `TRAEFIK_DASHBOARD_AUTH` in `.env` (htpasswd format, `$$` escaping)
- Dockge shares the Traefik `auth` middleware (same Basic Auth)

## Commands

### Provisioning (local)

```bash
export HCLOUD_TOKEN=... CLOUDFLARE_API_TOKEN=... CLOUDFLARE_ZONE_ID=...
./bootstrap.sh    # Create everything (~3-5 min)
./teardown.sh     # Destroy everything (requires "yes" confirmation)
```

### Docker Compose (on server)

```bash
cd /opt/homelab-repo/hetzner
docker compose up -d
docker compose logs -f <service>
docker compose ps
docker compose pull && docker compose up -d   # Update images
```

### Service Admin (on server)

```bash
# Headscale
docker exec headscale headscale users list
docker exec headscale headscale preauthkeys create --user homelab --expiration 24h

# ntfy admin user
docker exec -it ntfy ntfy user add --role=admin admin

# Healthchecks superuser
docker exec -it healthchecks ./manage.py createsuperuser
```

## Key Design Decisions

- No Terraform/CI/CD — shell scripts for simplicity, repo is public
- Cloudflare DNS records are `proxied = false` — required for Headscale DERP and WebSocket services
- Only IPv4 A-Records (no AAAA)
- Cloud-Init does base setup only. Repo clone, .env, docker compose are done by `bootstrap.sh` via SSH
- `headscale-setup.sh` is idempotent (safe to run multiple times)
- Traefik dashboard and Dockge share the same Basic Auth middleware
- Both PostgreSQL instances share the same `POSTGRES_PASSWORD` env var
- PostgreSQL volumes mount to `/var/lib/postgresql/data` (not `/var/lib/postgresql`)
- Headscale ACL SSH rules use `autogroup:member`/`autogroup:tagged` (wildcard `*` not supported)
- Headscale DERP server needs explicit `private_key_path` in config
- `bootstrap.sh` uses `remote()` helper with `-i` flag to avoid SSH key ambiguity

## Repo Structure

```
bootstrap.sh          # Provisioning script (local)
teardown.sh           # Teardown script (local)
cloud-init.yaml       # Server base setup (static, no templates)
README.md             # Project overview
SETUP.md              # Detailed setup guide
CLAUDE.md             # This file
hetzner/
  .env.example        # Environment template
  docker-compose.yml  # All services
  scripts/
    headscale-setup.sh  # Headscale bootstrap (runs on server)
  headplane/
    config.yaml
  headscale/
    acl.json
    config.yaml
    dns_records.json
  traefik/
    traefik.yml
```
