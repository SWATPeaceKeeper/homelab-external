# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Self-hosted homelab infrastructure on Hetzner Cloud (CX23, ~5 EUR/month). Provisioned via shell scripts (`bootstrap.sh` / `teardown.sh`) and Docker Compose. Documentation and comments are in German.

**Services:** Headscale v0.28 (VPN), Headplane v0.6.2-beta.5 (VPN UI), Traefik v3.6 (reverse proxy + SSL), Uptime Kuma (monitoring), ntfy (push notifications), Healthchecks (cron monitoring), Tailscale client, two PostgreSQL 17-alpine databases.

## Architecture

### Provisioning

- **`bootstrap.sh`** — Creates everything: Hetzner server + firewall + SSH key, Cloudflare DNS records, clones repo, generates `.env`, starts Docker Compose, bootstraps Headscale. Requires `HCLOUD_TOKEN`, `CLOUDFLARE_API_TOKEN`, `CLOUDFLARE_ZONE_ID`. Uses `remote()` helper with `-i "$SSH_KEY_FILE"` and `UserKnownHostsFile=/dev/null` for all SSH commands.
- **`teardown.sh`** — Destroys everything: server, firewall, SSH key, DNS records. Requires "yes" confirmation.
- **`cloud-init.yaml`** — Static (no template variables). Base setup only: packages, Docker, UFW, fail2ban, directory structure, acme.json, cookie_secret, swap. YAML gotcha: shell commands with colons must use list syntax `['bash', '-c', '...']` to avoid YAML parsing errors.
- No Terraform, no CI/CD, no GitHub Secrets. All provisioning runs locally.

### Runtime Configuration

- **`hetzner/`** — Deployed to `/opt/homelab-repo/hetzner/` on the server. Docker Compose orchestrates all services. Config changes deployed manually (`git pull` on server, then `docker compose up -d`).

### Network Architecture

- **`proxy` network**: Services exposed via Traefik (headscale, headplane, uptime-kuma, ntfy, healthchecks)
- **`internal` network**: Database containers + services that need DB access (headscale-postgres, healthchecks-postgres, headscale, headplane, healthchecks)
- **host network**: Tailscale client (needs NET_ADMIN)
- Routing configured via Traefik Docker labels on each service

### Data Separation

- **Git repo configs** (read-only mounts): `./traefik/`, `./headscale/`, `./headplane/`
- **Persistent data** (on server, not in git): `/opt/homelab-data/<service>/`
- **Secrets**: `/opt/homelab-data/secrets/` (cookie_secret generated by Cloud-Init)

### Secrets Management

- Three env vars needed locally for provisioning: `HCLOUD_TOKEN`, `CLOUDFLARE_API_TOKEN`, `CLOUDFLARE_ZONE_ID`
- Runtime secrets in `hetzner/.env` (generated by `bootstrap.sh`, never committed)
- Headscale DB password: env var `HEADSCALE_DATABASE_POSTGRES_PASS` overrides config.yaml value
- Traefik dashboard: Basic Auth via `TRAEFIK_DASHBOARD_AUTH` in `.env` (htpasswd format, `$$` escaping)

## Commands

### Provisioning (local)

```bash
export HCLOUD_TOKEN=... CLOUDFLARE_API_TOKEN=... CLOUDFLARE_ZONE_ID=...
./bootstrap.sh    # Create everything (~3-5 min)
./teardown.sh     # Destroy everything (requires "yes" confirmation)
```

### Docker Compose (on server)

```bash
cd /opt/homelab-repo/hetzner
docker compose up -d
docker compose logs -f <service>
docker compose ps
docker compose pull && docker compose up -d   # Update images
```

### Service Admin (on server)

```bash
# Headscale
docker exec headscale headscale users list
docker exec headscale headscale preauthkeys create --user homelab --expiration 24h

# ntfy admin user
docker exec -it ntfy ntfy user add --role=admin admin

# Healthchecks superuser (set password via Web UI afterwards)
docker exec healthchecks ./manage.py createsuperuser --noinput --email admin@example.com
```

## Key Design Decisions

- No Terraform/CI/CD — shell scripts for simplicity, repo is public
- Cloudflare DNS records are `proxied = false` — required for Headscale DERP and WebSocket services
- Only IPv4 A-Records (no AAAA), 5 subdomains: headscale, uptime, ntfy, hc, traefik
- Cloud-Init does base setup only. Repo clone, .env, docker compose are done by `bootstrap.sh` via SSH
- `headscale-setup.sh` is idempotent (safe to run multiple times)
- Both PostgreSQL instances share the same `POSTGRES_PASSWORD` env var
- PostgreSQL volumes mount to `/var/lib/postgresql/data` (not `/var/lib/postgresql`)
- Headscale ACL SSH rules use `autogroup:member`/`autogroup:tagged` (wildcard `*` not supported in v0.28)
- Headscale DERP server needs explicit `private_key_path` in config
- Headscale postgres `ssl: false` (not `disable` — Headplane validator rejects `disable`)

## Known Pitfalls

- **Headplane version**: Must match Headscale version. v0.6.1 does NOT work with Headscale v0.28. Use v0.6.2-beta.5+.
- **Headplane healthcheck**: Binary at `/bin/hp_healthcheck`. Unhealthy containers are invisible to Traefik (no routing).
- **Headplane Docker socket**: Config requires `unix:///var/run/docker.sock` prefix (not just the path).
- **Headplane Traefik routing**: Needs explicit `priority=200` so `/admin` paths go to Headplane, not the Headscale catch-all router.
- **SSH known_hosts**: `bootstrap.sh` uses `UserKnownHostsFile=/dev/null` because server IPs get reused after teardown/rebuild.
- **Cloud-init YAML**: Colons in shell commands break YAML parsing. Use list syntax: `['bash', '-c', 'echo "done: $(date)"']`.

## Repo Structure

```
bootstrap.sh          # Provisioning script (local)
teardown.sh           # Teardown script (local)
cloud-init.yaml       # Server base setup (static, no templates)
README.md             # Project overview
SETUP.md              # Detailed setup guide
CLAUDE.md             # This file
hetzner/
  .env.example        # Environment template
  docker-compose.yml  # All services
  scripts/
    headscale-setup.sh  # Headscale bootstrap (runs on server)
  headplane/
    config.yaml
  headscale/
    acl.json
    config.yaml
    dns_records.json  # Extra DNS records (empty template)
  traefik/
    traefik.yml
```
