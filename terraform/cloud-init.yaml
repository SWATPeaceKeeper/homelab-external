#cloud-config
# ============================================================================
# Homelab External Server - Cloud-Init (Basis-Provisionierung)
# ============================================================================
#
# Diese Datei macht NUR das Basis-Setup des Servers:
# - System-Updates
# - Docker Installation
# - Firewall
# - Ordnerstruktur
#
# Die eigentliche Konfiguration (Configs, Docker Compose, etc.) erfolgt
# MANUELL nach dem Server-Setup. Siehe SETUP.md für Anleitung.
#
# ============================================================================

# -----------------------------------------------------------------------------
# 1. SYSTEM-UPDATES
# -----------------------------------------------------------------------------
# Aktualisiert Paketlisten und installiert verfügbare Updates beim ersten Boot.
# Das dauert 1-2 Minuten, stellt aber sicher dass der Server aktuell ist.
# -----------------------------------------------------------------------------
package_update: true
package_upgrade: true

# -----------------------------------------------------------------------------
# 2. BASIS-PAKETE
# -----------------------------------------------------------------------------
# Diese Pakete werden installiert:
# - ca-certificates, curl: Für HTTPS Downloads (Docker, etc.)
# - git: Zum Klonen des Config-Repositories
# - htop, vim: Nützliche Admin-Tools
# - jq: JSON-Verarbeitung (für Scripts)
# - fail2ban: Schutz gegen Brute-Force Angriffe
# - ufw: Einfache Firewall
# -----------------------------------------------------------------------------
packages:
  - ca-certificates
  - curl
  - git
  - htop
  - vim
  - jq
  - fail2ban
  - ufw

# -----------------------------------------------------------------------------
# 3. SSH DEPLOY KEY FÜR GITHUB
# -----------------------------------------------------------------------------
# Der Private Key wird Base64-kodiert übertragen (vermeidet YAML-Probleme).
# Damit kann der Server das private GitHub-Repository klonen.
# Der Public Key muss als Deploy Key im GitHub Repo hinterlegt werden!
# -----------------------------------------------------------------------------
write_files:
  - path: /root/.ssh/deploy_key
    permissions: '0600'
    encoding: b64
    content: ${deploy_key_private_b64}

  - path: /root/.ssh/config
    permissions: '0644'
    content: |
      Host github.com
        HostName github.com
        User git
        IdentityFile /root/.ssh/deploy_key
        StrictHostKeyChecking no

# -----------------------------------------------------------------------------
# 4. SETUP COMMANDS
# -----------------------------------------------------------------------------
runcmd:
  # =========================================================================
  # 4.1 DOCKER INSTALLATION (Ubuntu 24.04 - Aktuelle Methode 2025)
  # =========================================================================
  # Quelle: https://docs.docker.com/engine/install/ubuntu/
  #
  # Schritt 1: Keyring-Verzeichnis erstellen
  - install -m 0755 -d /etc/apt/keyrings

  # Schritt 2: Docker GPG Key herunterladen (neuer Pfad seit 2024)
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc

  # Schritt 3: Docker Repository hinzufügen
  - |
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

  # Schritt 4: Docker installieren
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # Schritt 5: Docker starten und aktivieren
  - systemctl enable docker
  - systemctl start docker

  # Optional: Symlink für "docker-compose" Befehl (Kompatibilität)
  - ln -sf /usr/libexec/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose

  # =========================================================================
  # 4.2 FIREWALL (UFW)
  # =========================================================================
  # Standard: Alles blockieren außer explizit erlaubte Ports
  # =========================================================================
  - ufw default deny incoming
  - ufw default allow outgoing

  # SSH (Port 22) - WICHTIG: Immer erlauben!
  - ufw allow ssh

  # HTTP/HTTPS für Traefik
  - ufw allow 80/tcp
  - ufw allow 443/tcp

  # Headscale DERP/STUN (für VPN-Verbindungen)
  - ufw allow 3478/udp
  - ufw allow 3478/tcp

  # Firewall aktivieren
  - ufw --force enable

  # =========================================================================
  # 4.3 FAIL2BAN
  # =========================================================================
  # Schützt gegen Brute-Force SSH Angriffe
  # =========================================================================
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # =========================================================================
  # 4.4 ORDNERSTRUKTUR
  # =========================================================================
  # /opt/homelab-repo/                    -> Git Repository (komplettes Repo)
  # /opt/homelab -> /opt/homelab-repo/hetzner  -> Symlink (Arbeitsverzeichnis)
  # /opt/homelab-data/                    -> Persistente Daten (AUSSERHALB Git!)
  # /opt/homelab/data -> /opt/homelab-data     -> Symlink (docker-compose nutzt ./data/)
  # =========================================================================

  # Verzeichnisse erstellen
  - mkdir -p /opt/homelab-repo
  - mkdir -p /opt/homelab-data/traefik/certs
  - mkdir -p /opt/homelab-data/headscale
  - mkdir -p /opt/homelab-data/headscale-postgres
  - mkdir -p /opt/homelab-data/headplane
  - mkdir -p /opt/homelab-data/uptime-kuma
  - mkdir -p /opt/homelab-data/ntfy/cache
  - mkdir -p /opt/homelab-data/ntfy/data
  - mkdir -p /opt/homelab-data/healthchecks
  - mkdir -p /opt/homelab-data/healthchecks-postgres
  - mkdir -p /opt/homelab-data/tailscale

  # acme.json für Let's Encrypt Zertifikate (MUSS 600 sein!)
  - touch /opt/homelab-data/traefik/certs/acme.json
  - chmod 600 /opt/homelab-data/traefik/certs/acme.json

  # =========================================================================
  # 4.5 ABSCHLUSS
  # =========================================================================
  - echo "========================================" >> /var/log/cloud-init-complete.log
  - 'echo "Cloud-Init abgeschlossen: $(date)" >> /var/log/cloud-init-complete.log'
  - echo "========================================" >> /var/log/cloud-init-complete.log
  - echo "Server ist bereit fuer manuelle Konfiguration." >> /var/log/cloud-init-complete.log
  - echo "Siehe SETUP.md im Repository fuer naechste Schritte." >> /var/log/cloud-init-complete.log

# -----------------------------------------------------------------------------
# 5. SYSTEM-KONFIGURATION
# -----------------------------------------------------------------------------
timezone: Europe/Berlin
locale: de_DE.UTF-8

# SSH: Nur Key-Authentifizierung (kein Passwort)
ssh_pwauth: false
disable_root: false

# -----------------------------------------------------------------------------
# 6. SWAP (für Low-Memory Situationen)
# -----------------------------------------------------------------------------
# 2GB Swap ist sinnvoll für Server mit 4GB RAM
# Verhindert OOM-Kills bei Lastspitzen
# -----------------------------------------------------------------------------
swap:
  filename: /swapfile
  size: 2G
  maxsize: 2G
