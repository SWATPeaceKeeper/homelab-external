// ==========================================================================
// HEADSCALE ACL (Access Control List)
// ==========================================================================
// Dokumentation: https://headscale.net/stable/ref/acls/
// Format: HuJSON (JSON mit Kommentaren)
// Policy v2 (ab Headscale v0.26+): User-Referenzen mit @ am Ende
//
// Nach Änderungen: docker compose restart headscale
// ==========================================================================

{
  // TAG OWNERS
  // Nur User "homelab" darf tag:server vergeben
  "tagOwners": {
    "tag:server": ["homelab@"]
  },

  // HOSTS (Aliase)
  "hosts": {
    "homelab-network": "10.10.10.0/24"
  },

  // AUTO-APPROVAL
  // Routen und Exit Nodes werden automatisch freigegeben
  "autoApprovers": {
    "routes": {
      "10.10.10.0/24": ["homelab@"]
    },
    "exitNode": ["homelab@"]
  },

  // ACL REGELN
  "acls": [
    // Persönliche Geräte (untagged): voller VPN-Zugriff
    {
      "action": "accept",
      "src": ["autogroup:member"],
      "dst": ["*:*"]
    },

    // Persönliche Geräte: Internet über Exit Node
    {
      "action": "accept",
      "src": ["autogroup:member"],
      "dst": ["autogroup:internet:*"]
    },

    // Hetzner-Server (tag:server): Monitoring-Zugriff auf Homelab
    {
      "action": "accept",
      "src": ["tag:server"],
      "dst": [
        "homelab-network:80",
        "homelab-network:443",
        "homelab-network:3000",
        "homelab-network:8080",
        "homelab-network:8123",
        "homelab-network:9090",
        "homelab-network:9100"
      ]
    },

    // ICMP (Ping) für Diagnose
    {
      "action": "accept",
      "src": ["*"],
      "dst": ["*:*"],
      "proto": "icmp"
    }
  ],

  // SSH REGELN (Tailscale SSH)
  "ssh": [
    {
      "action": "accept",
      "src": ["autogroup:member"],
      "dst": ["autogroup:member", "autogroup:tagged"],
      "users": ["autogroup:nonroot", "root"]
    }
  ]
}
