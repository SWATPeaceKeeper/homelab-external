# ============================================================================
# Homelab External - Docker Compose
# ============================================================================
# Standort: Hetzner vServer
# Pfad auf Server: /opt/homelab-repo/hetzner/docker-compose.yml
#
# VOLUME-STRUKTUR:
# - Configs:  ./traefik/, ./headscale/, ./headplane/ (aus Git Repository)
# - Daten:    /opt/homelab-data/ (persistente Daten, für Backups)
#
# NETZWERKE:
# - proxy:    Für Services die von außen erreichbar sein sollen
# - internal: Für interne Kommunikation zwischen Services
# ============================================================================

services:
  # =========================================================================
  # TRAEFIK - Reverse Proxy & SSL
  # =========================================================================
  # Traefik ist der zentrale Eingangspunkt für alle HTTP/HTTPS Anfragen.
  # Er kümmert sich um:
  # - SSL-Zertifikate (Let's Encrypt)
  # - Routing zu den einzelnen Services
  # - HTTP → HTTPS Redirect
  # =========================================================================
  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      # HTTP (wird zu HTTPS weitergeleitet)
      - "80:80"
      # HTTPS (Haupteingang)
      - "443:443"
      # Headscale DERP/STUN (für VPN Performance)
      - "3478:3478/udp"
      - "3478:3478/tcp"
    volumes:
      # Docker Socket (damit Traefik Container erkennt) - READ ONLY!
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Traefik Konfiguration
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      # SSL Zertifikate (DATEN - wird von Traefik geschrieben)
      - /opt/homelab-data/traefik/certs:/etc/traefik/certs
      # Access Logs
      - /var/log/traefik:/var/log/traefik
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"

  # =========================================================================
  # POSTGRESQL - Datenbank für Headscale
  # =========================================================================
  # PostgreSQL ist die empfohlene Datenbank für Headscale in Produktion.
  # Robuster als SQLite, besonders bei vielen Nodes.
  # =========================================================================
  headscale-postgres:
    image: postgres:17-alpine
    container_name: headscale-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=headscale
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=headscale
    volumes:
      - /opt/homelab-data/headscale-postgres:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U headscale"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================================================================
  # HEADSCALE - VPN Coordination Server
  # =========================================================================
  # Headscale ist die selbst-gehostete Alternative zu Tailscale's
  # Koordinationsserver. Er verwaltet:
  # - Benutzer und Geräte im VPN
  # - Schlüsselaustausch
  # - ACL Regeln (wer darf wohin)
  #
  # WICHTIG: Nach dem ersten Start musst du einen User erstellen:
  # docker exec headscale headscale users create homelab
  # =========================================================================
  headscale:
    image: ghcr.io/juanfont/headscale:stable
    container_name: headscale
    restart: unless-stopped
    command: serve
    depends_on:
      headscale-postgres:
        condition: service_healthy
    environment:
      # Überschreibt database.postgres.pass aus config.yaml
      # So bleibt das Passwort in .env und nicht in der Config-Datei
      - HEADSCALE_DATABASE_POSTGRES_PASS=${POSTGRES_PASSWORD}
    volumes:
      - ./headscale/config.yaml:/etc/headscale/config.yaml
      - ./headscale/acl.json:/etc/headscale/acl.json
      - ./headscale/dns_records.json:/etc/headscale/dns_records.json
      - /opt/homelab-data/headscale:/var/lib/headscale
    networks:
      - proxy
      - internal
    healthcheck:
        test: ["CMD", "headscale", "health"]
    labels:
      # Traefik labels to expose Headscale at headscale.example.com
      - "traefik.enable=true"
      - "traefik.http.routers.headscale.rule=Host(`headscale.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.headscale.tls=true"
      - "traefik.http.routers.headscale.tls.certresolver=letsencrypt"
      - "traefik.http.routers.headscale.entrypoints=websecure"
      # This middleware is essential to ensuring Headplane works correctly
      - 'traefik.http.routers.headscale.middlewares=cors'
      - 'traefik.http.middlewares.cors.headers.accesscontrolallowheaders=*'
      - 'traefik.http.middlewares.cors.headers.accesscontrolallowmethods=GET,POST,PUT'
      - 'traefik.http.middlewares.cors.headers.accesscontrolalloworiginlist=https://headscale.${SUBDOMAIN_PREFIX}.${DOMAIN}'
      - 'traefik.http.middlewares.cors.headers.accesscontrolmaxage=100'
      - 'traefik.http.middlewares.cors.headers.addvaryheader=true'
      # Headscale Service Port
      - "traefik.http.services.headscale.loadbalancer.server.port=8080"
      # Redirect / to /admin (Headplane UI)
      - 'traefik.http.routers.rewrite.rule=Host(`headscale.${SUBDOMAIN_PREFIX}.${DOMAIN}`) && Path(`/`)'
      - 'traefik.http.routers.rewrite.entrypoints=websecure'
      - 'traefik.http.routers.rewrite.tls=true'
      - 'traefik.http.routers.rewrite.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.rewrite.middlewares=rewrite'
      - 'traefik.http.middlewares.rewrite.redirectregex.regex=^https://headscale.${SUBDOMAIN_PREFIX}.${DOMAIN}/?$$'
      - 'traefik.http.middlewares.rewrite.redirectregex.replacement=https://headscale.${SUBDOMAIN_PREFIX}.${DOMAIN}/admin'

  # =========================================================================
  # HEADPLANE - VPN Web UI
  # =========================================================================
  # Headplane ist eine Web-Oberfläche für Headscale.
  # Damit kannst du Benutzer, Geräte und Einstellungen verwalten.
  #
  # WICHTIG: Benötigt einen Headscale API Key:
  # docker exec headscale headscale apikeys create --expiration 365d
  # Dann in .env eintragen: HEADSCALE_API_KEY=...
  # =========================================================================
  headplane:
    image: ghcr.io/tale/headplane:latest
    container_name: headplane
    restart: unless-stopped
    volumes:
      - ./headplane/config.yaml:/etc/headplane/config.yaml
      - /opt/homelab-data/headplane:/var/lib/headplane
      - ./headscale/config.yaml:/etc/headscale/config.yaml
      - ./headscale/dns_records.json:/etc/headscale/dns_records.json
      - ./headscale/acl.json:/etc/headscale/acl.json
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Cookie Secret aus Datei (nicht in Git)
      - /opt/homelab-data/secrets/cookie_secret:/run/secrets/cookie_secret:ro
    depends_on:
      - headscale
    healthcheck:
      test: ["CMD", "/bin/hp_healthcheck"]
      interval: 30s
      timeout: 5s
      start_period: 5s
      retries: 3
    networks:
      - proxy
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.headplane.rule=Host(`headscale.${SUBDOMAIN_PREFIX}.${DOMAIN}`) && PathPrefix(`/admin`)"
      - "traefik.http.routers.headplane.entrypoints=websecure"
      - "traefik.http.routers.headplane.tls=true"
      - "traefik.http.routers.headplane.tls.certresolver=letsencrypt"
      - "traefik.http.routers.headplane.priority=200"
      - "traefik.http.services.headplane.loadbalancer.server.port=3000"

  # =========================================================================
  # TAILSCALE CLIENT - Verbindung zum Homelab
  # =========================================================================
  # Dieser Container verbindet den Hetzner Server mit deinem VPN.
  # Dadurch können die Monitoring-Services (Uptime Kuma etc.)
  # deine internen Homelab-Dienste erreichen.
  #
  # SETUP nach Headscale-Konfiguration:
  # 1. Pre-Auth Key erstellen:
  #    docker exec headscale headscale preauthkeys create --user homelab --expiration 24h
  # 2. Key in .env eintragen: TS_AUTHKEY=...
  # 3. Container neu starten
  # =========================================================================
  tailscale:
    image: ghcr.io/tailscale/tailscale:stable
    container_name: tailscale
    hostname: hetzner-server
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - /opt/homelab-data/tailscale:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    environment:
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--login-server=https://headscale.${SUBDOMAIN_PREFIX}.${DOMAIN} --accept-dns=false
      # Pre-Auth Key (nach Headscale-Setup eintragen)
      - TS_AUTHKEY=${TS_AUTHKEY:-}
    network_mode: host

  # =========================================================================
  # UPTIME KUMA - Uptime Monitoring
  # =========================================================================
  # Überwacht die Erreichbarkeit deiner Services.
  # Kann Benachrichtigungen senden wenn etwas down ist.
  # =========================================================================
  uptime-kuma:
    image: louislam/uptime-kuma:2
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - /opt/homelab-data/uptime-kuma:/app/data
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.uptime.rule=Host(`uptime.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.uptime.tls=true"
      - "traefik.http.routers.uptime.tls.certresolver=letsencrypt"
      - "traefik.http.services.uptime.loadbalancer.server.port=3001"

  # =========================================================================
  # NTFY - Push Notifications
  # =========================================================================
  # Selbst-gehosteter Push-Notification Server.
  # Kann von allen deinen Services genutzt werden um Benachrichtigungen
  # an dein Handy zu senden.
  #
  # SETUP nach Start:
  # docker exec -it ntfy ntfy user add --role=admin admin
  # =========================================================================
  ntfy:
    image: binwiederhier/ntfy:latest
    container_name: ntfy
    restart: unless-stopped
    command: serve
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - NTFY_BASE_URL=https://ntfy.${SUBDOMAIN_PREFIX}.${DOMAIN}
      - NTFY_UPSTREAM_BASE_URL=https://ntfy.sh
      - NTFY_AUTH_DEFAULT_ACCESS=deny-all
      - NTFY_CACHE_FILE=/var/lib/ntfy/cache.db
      - NTFY_AUTH_FILE=/var/lib/ntfy/auth.db
      - NTFY_ATTACHMENT_CACHE_DIR=/var/lib/ntfy/attachments
      - NTFY_BEHIND_PROXY=true
      - NTFY_ENABLE_LOGIN=true
    volumes:
      - /opt/homelab-data/ntfy/cache:/var/cache/ntfy
      - /opt/homelab-data/ntfy/data:/var/lib/ntfy
    networks:
      - proxy
    healthcheck:
      test: ["CMD-SHELL", "wget -q --tries=1 http://localhost:80/v1/health -O - | grep -Eo '\"healthy\"\\s*:\\s*true' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ntfy.rule=Host(`ntfy.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.ntfy.tls=true"
      - "traefik.http.routers.ntfy.tls.certresolver=letsencrypt"
      - "traefik.http.services.ntfy.loadbalancer.server.port=80"

  # =========================================================================
  # HEALTHCHECKS - Cronjob Monitoring
  # =========================================================================
  # Überwacht ob deine Cronjobs/Scheduled Tasks laufen.
  # Jeder Job pingt eine URL - wenn der Ping ausbleibt, wirst du benachrichtigt.
  # =========================================================================
  healthchecks:
    image: healthchecks/healthchecks:latest
    container_name: healthchecks
    restart: unless-stopped
    environment:
      - ALLOWED_HOSTS=hc.${SUBDOMAIN_PREFIX}.${DOMAIN}
      - APPRISE_ENABLED=True
      - DB=postgres
      - DB_HOST=healthchecks-postgres
      - DB_NAME=healthchecks
      - DB_USER=healthchecks
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DEFAULT_FROM_EMAIL=healthchecks@${DOMAIN}
      - EMAIL_HOST=smtp.eu.mailgun.org
      - EMAIL_HOST_PASSWORD=${HEALTHCHECKS_SMTP_PASSWORD}
      - EMAIL_HOST_USER=healthchecks@mailgun.robinwerner.net
      - PING_BODY_LIMIT=100000
      - PING_EMAIL_DOMAIN=hc.${SUBDOMAIN_PREFIX}.${DOMAIN}
      - REGISTRATION_OPEN=False
      - SECRET_KEY=${HEALTHCHECKS_SECRET}
      - SITE_NAME=Homelab Healthchecks
      - SITE_ROOT=https://hc.${SUBDOMAIN_PREFIX}.${DOMAIN}
    volumes:
      - /opt/homelab-data/healthchecks:/data
    networks:
      - proxy
      - internal
    depends_on:
      healthchecks-postgres:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.healthchecks.rule=Host(`hc.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.healthchecks.tls=true"
      - "traefik.http.routers.healthchecks.tls.certresolver=letsencrypt"
      - "traefik.http.services.healthchecks.loadbalancer.server.port=8000"

  healthchecks-postgres:
    image: postgres:17-alpine
    container_name: healthchecks-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=healthchecks
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=healthchecks
    volumes:
      - /opt/homelab-data/healthchecks-postgres:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U healthchecks"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================================================================
  # DOCKGE - Docker Compose Manager
  # =========================================================================
  # Web-basierter Docker Compose Manager.
  # Nutzt die bestehende Traefik Basic Auth Middleware.
  # =========================================================================
  dockge:
    image: louislam/dockge:1
    container_name: dockge
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      - DOCKGE_STACKS_DIR=/opt/stacks
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /opt/homelab-data/dockge:/app/data
      - /opt/stacks:/opt/stacks
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dockge.rule=Host(`dockge.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.dockge.tls=true"
      - "traefik.http.routers.dockge.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dockge.middlewares=auth"
      - "traefik.http.services.dockge.loadbalancer.server.port=5001"

# =============================================================================
# NETZWERKE
# =============================================================================
networks:
  # Für Services die von außen erreichbar sein sollen
  proxy:
    name: proxy
    driver: bridge
  # Für interne Kommunikation (z.B. Headplane → Headscale)
  internal:
    name: internal
    driver: bridge
