# ============================================================================
# Homelab External - Docker Compose
# ============================================================================
# Standort: Hetzner vServer
# Pfad auf Server: /opt/homelab/docker-compose.yml
#
# VOLUME-STRUKTUR:
# - Configs:  ./traefik/, ./headscale/, ./headplane/ (aus Git Repository)
# - Daten:    ./data/ (persistente Daten, für Backups)
#
# NETZWERKE:
# - proxy:    Für Services die von außen erreichbar sein sollen
# - internal: Für interne Kommunikation zwischen Services
# ============================================================================

services:
  # =========================================================================
  # TRAEFIK - Reverse Proxy & SSL
  # =========================================================================
  # Traefik ist der zentrale Eingangspunkt für alle HTTP/HTTPS Anfragen.
  # Er kümmert sich um:
  # - SSL-Zertifikate (Let's Encrypt)
  # - Routing zu den einzelnen Services
  # - HTTP → HTTPS Redirect
  # =========================================================================
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      # HTTP (wird zu HTTPS weitergeleitet)
      - "80:80"
      # HTTPS (Haupteingang)
      - "443:443"
      # Headscale DERP/STUN (für VPN Performance)
      - "3478:3478/udp"
      - "3478:3478/tcp"
    volumes:
      # Docker Socket (damit Traefik Container erkennt) - READ ONLY!
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Traefik Konfiguration
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/config:/etc/traefik/config:ro
      # SSL Zertifikate (DATEN - wird von Traefik geschrieben)
      - ./data/traefik/certs:/etc/traefik/certs
      # Access Logs
      - /var/log/traefik:/var/log/traefik
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      # Dashboard (optional - für Debugging)
      # ACHTUNG: Ändere das Passwort! Generieren mit: htpasswd -nb admin DEINPASSWORT
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"

  # =========================================================================
  # POSTGRESQL - Datenbank für Headscale
  # =========================================================================
  # PostgreSQL ist die empfohlene Datenbank für Headscale in Produktion.
  # Robuster als SQLite, besonders bei vielen Nodes.
  # =========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=headscale
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=headscale
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U headscale"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================================================================
  # HEADSCALE - VPN Coordination Server
  # =========================================================================
  # Headscale ist die selbst-gehostete Alternative zu Tailscale's
  # Koordinationsserver. Er verwaltet:
  # - Benutzer und Geräte im VPN
  # - Schlüsselaustausch
  # - ACL Regeln (wer darf wohin)
  #
  # WICHTIG: Nach dem ersten Start musst du einen User erstellen:
  # docker exec headscale headscale users create homelab
  # =========================================================================
  headscale:
    image: headscale/headscale:latest
    container_name: headscale
    restart: unless-stopped
    command: serve
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # Konfiguration (aus Git)
      - ./headscale/config.yaml:/etc/headscale/config.yaml:ro
      - ./headscale/acl.json:/etc/headscale/acl.json:ro
      # Daten (Keys, etc. - Datenbank ist jetzt in PostgreSQL)
      - ./data/headscale:/var/lib/headscale
    networks:
      - proxy
      - internal
    labels:
      - "traefik.enable=true"
      # Haupt-Router für API und Web
      - "traefik.http.routers.headscale.rule=Host(`headscale.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.headscale.tls=true"
      - "traefik.http.routers.headscale.tls.certresolver=letsencrypt"
      - "traefik.http.routers.headscale.entrypoints=websecure"
      - "traefik.http.services.headscale.loadbalancer.server.port=8080"

  # =========================================================================
  # HEADPLANE - VPN Web UI
  # =========================================================================
  # Headplane ist eine Web-Oberfläche für Headscale.
  # Damit kannst du Benutzer, Geräte und Einstellungen verwalten.
  #
  # WICHTIG: Benötigt einen Headscale API Key:
  # docker exec headscale headscale apikeys create --expiration 365d
  # Dann in .env eintragen: HEADSCALE_API_KEY=...
  # =========================================================================
  headplane:
    image: ghcr.io/tale/headplane:latest
    container_name: headplane
    restart: unless-stopped
    volumes:
      # Konfiguration
      - ./headplane/config.yaml:/etc/headplane/config.yaml:ro
      # Headscale Config (für Integration)
      - ./headscale/config.yaml:/etc/headscale/config.yaml:ro
      # Daten
      - ./data/headplane:/var/lib/headplane
    depends_on:
      - headscale
    networks:
      - proxy
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.headplane.rule=Host(`vpn.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.headplane.tls=true"
      - "traefik.http.routers.headplane.tls.certresolver=letsencrypt"
      - "traefik.http.services.headplane.loadbalancer.server.port=3000"

  # =========================================================================
  # TAILSCALE CLIENT - Verbindung zum Homelab
  # =========================================================================
  # Dieser Container verbindet den Hetzner Server mit deinem VPN.
  # Dadurch können die Monitoring-Services (Uptime Kuma etc.)
  # deine internen Homelab-Dienste erreichen.
  #
  # SETUP nach Headscale-Konfiguration:
  # 1. Pre-Auth Key erstellen:
  #    docker exec headscale headscale preauthkeys create --user homelab --expiration 24h
  # 2. Key in .env eintragen: TS_AUTHKEY=...
  # 3. Container neu starten
  # =========================================================================
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    hostname: hetzner-server
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - ./data/tailscale:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    environment:
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--login-server=https://headscale.${SUBDOMAIN_PREFIX}.${DOMAIN} --accept-dns=false
      # Pre-Auth Key (nach Headscale-Setup eintragen)
      - TS_AUTHKEY=${TS_AUTHKEY:-}
    network_mode: host

  # =========================================================================
  # UPTIME KUMA - Uptime Monitoring
  # =========================================================================
  # Überwacht die Erreichbarkeit deiner Services.
  # Kann Benachrichtigungen senden wenn etwas down ist.
  # =========================================================================
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - ./data/uptime-kuma:/app/data
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.uptime.rule=Host(`uptime.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.uptime.tls=true"
      - "traefik.http.routers.uptime.tls.certresolver=letsencrypt"
      - "traefik.http.services.uptime.loadbalancer.server.port=3001"

  # =========================================================================
  # NTFY - Push Notifications
  # =========================================================================
  # Selbst-gehosteter Push-Notification Server.
  # Kann von allen deinen Services genutzt werden um Benachrichtigungen
  # an dein Handy zu senden.
  #
  # SETUP nach Start:
  # docker exec -it ntfy ntfy user add --role=admin admin
  # =========================================================================
  ntfy:
    image: binwiederhier/ntfy:latest
    container_name: ntfy
    restart: unless-stopped
    command: serve
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - NTFY_BASE_URL=https://ntfy.${SUBDOMAIN_PREFIX}.${DOMAIN}
      - NTFY_UPSTREAM_BASE_URL=https://ntfy.sh
      - NTFY_AUTH_DEFAULT_ACCESS=deny-all
      - NTFY_AUTH_FILE=/var/lib/ntfy/user.db
      - NTFY_BEHIND_PROXY=true
      - NTFY_ENABLE_SIGNUP=false
    volumes:
      - ./data/ntfy/cache:/var/cache/ntfy
      - ./data/ntfy/data:/var/lib/ntfy
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ntfy.rule=Host(`ntfy.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.ntfy.tls=true"
      - "traefik.http.routers.ntfy.tls.certresolver=letsencrypt"
      - "traefik.http.services.ntfy.loadbalancer.server.port=80"

  # =========================================================================
  # HEALTHCHECKS - Cronjob Monitoring
  # =========================================================================
  # Überwacht ob deine Cronjobs/Scheduled Tasks laufen.
  # Jeder Job pingt eine URL - wenn der Ping ausbleibt, wirst du benachrichtigt.
  # =========================================================================
  healthchecks:
    image: healthchecks/healthchecks:latest
    container_name: healthchecks
    restart: unless-stopped
    environment:
      - ALLOWED_HOSTS=hc.${SUBDOMAIN_PREFIX}.${DOMAIN}
      - APPRISE_ENABLED=True
      - DB=sqlite
      - DB_NAME=/data/hc.sqlite
      - DEBUG=False
      - DEFAULT_FROM_EMAIL=noreply@${DOMAIN}
      - PING_BODY_LIMIT=100000
      - PING_EMAIL_DOMAIN=hc.${SUBDOMAIN_PREFIX}.${DOMAIN}
      - REGISTRATION_OPEN=False
      - SECRET_KEY=${HEALTHCHECKS_SECRET}
      - SITE_NAME=Homelab Healthchecks
      - SITE_ROOT=https://hc.${SUBDOMAIN_PREFIX}.${DOMAIN}
    volumes:
      - ./data/healthchecks:/data
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.healthchecks.rule=Host(`hc.${SUBDOMAIN_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.healthchecks.tls=true"
      - "traefik.http.routers.healthchecks.tls.certresolver=letsencrypt"
      - "traefik.http.services.healthchecks.loadbalancer.server.port=8000"

# =============================================================================
# NETZWERKE
# =============================================================================
networks:
  # Für Services die von außen erreichbar sein sollen
  proxy:
    name: proxy
    driver: bridge
  # Für interne Kommunikation (z.B. Headplane → Headscale)
  internal:
    name: internal
    driver: bridge
